import*as e from"three";import*as a from"pixy";import t from"three/addons/capabilities/WebGL.js";import i from"three/addons/libs/stats.module.js";import{GUI as n}from"three/addons/libs/lil-gui.module.min.js";import{CopyShader as r}from"three/addons/shaders/CopyShader.js";import{OrbitControls as l}from"three/addons/controls/OrbitControls.js";!1===t.isWebGLAvailable()&&document.body.appendChild(t.getWebGLErrorMessage());const s={mouse:new e.Vector2(.5,.5),canvas:void 0,camera:void 0,dummyCamera:void 0,constrols:void 0,scene:void 0,renderer:void 0,noise:{scene:void 0,sphere:void 0,uniforms:void 0,material:void 0,texture:void 0},grungeTexture:void 0,gui:{root:void 0,tiling:void 0,tone:void 0,normalMap:void 0,cb:void 0,pars:void 0,parsItems:void 0},stats:void 0,clock:new e.Clock,effectController:void 0,layers:[],spriteSheet:{},alphaOptions:{},shaderDefines:void 0,init(){this.initGraphics(),this.initScene(),this.setupGui(),this.initLayers(),console.log("[fxgen] initialized")},initGraphics(){console.log("[fxgen] initializing graphics..."),this.renderer=new e.WebGLRenderer,this.renderer.setSize(512,512),this.renderer.capabilities.isWebGL2&&console.log("WebGL2");let a=this;this.canvas=this.renderer.domElement,this.canvas.addEventListener("mousemove",(e=>{a.mouse.x=e.offsetX/a.canvas.width,a.mouse.y=e.offsetY/a.canvas.height})),document.body.appendChild(this.canvas),this.alphaCanvas=document.createElement("canvas"),this.alphaCanvas.style.display="none",document.body.appendChild(this.alphaCanvas),this.saveCanvas=document.createElement("canvas"),this.blur50=document.createElement("canvas"),this.blur25=document.createElement("canvas"),this.stats=new i,document.body.appendChild(this.stats.dom)},initScene(){let t,i,n;console.log("[fxgen] initializing scene..."),this.scene=new e.Scene,this.noise.scene=new e.Scene,this.camera=new e.PerspectiveCamera(45,1,1,1e3),this.camera.position.set(0,0,3.8),this.dummyCamera=new e.Camera,this.controls=new l(this.camera,this.renderer.domElement),this.controls.target.set(0,0,0),this.controls.addEventListener("change",this.render.bind(this)),t=new e.PlaneGeometry(2,2),i=new e.Mesh(t,new e.MeshBasicMaterial),this.scene.add(i),this.grungeTexture=(new e.TextureLoader).load("images/grunge.png"),this.grungeTexture.wrapS=this.grungeTexture.wrapT=e.RepeatWrapping,this.grungeTexture.minFilter=e.LinearFilter,this.grungeTexture.magFilter=e.LinearFilter,this.grungeTexture.anisotropy=16,t=new e.SphereGeometry(1,1024,1024),n=new a.FxgenShader,n.enable("DISPLACEMENT"),n.enable("GLSL3"),this.noise.uniforms=n.generateUniforms(),this.noise.material=n.createStandardMaterial(this.noise.uniforms),this.noise.sphere=new e.Mesh(t,this.noise.material),this.noise.scene.add(this.noise.sphere),n=new a.FxgenShader,this.shaderDefines=n.generateDefines(),this.spriteSheet.uniforms=e.UniformsUtils.clone(r.uniforms),this.spriteSheet.material=new e.ShaderMaterial({uniforms:this.spriteSheet.uniforms,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,depthTest:!1,depthWrite:!1}),this.spriteSheet.uniforms.opacity.value=1,this.spriteSheet.camera=new e.OrthographicCamera(-1,1,1,-1,0,1),this.spriteSheet.scene=new e.Scene,this.spriteSheet.quad=new e.Mesh(new e.PlaneGeometry(2,2),this.spriteSheet.material),this.spriteSheet.dimension=8,this.spriteSheet.time=0,this.spriteSheet.timeLength=3,this.spriteSheet.timeStep=.1,this.spriteSheet.scene.add(this.spriteSheet.quad)},initLayers(){console.log("[fxgen] initializing layers..."),this.layers=[];let t={name:"Base"};t.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1});let i=new a.FxgenShader,n=this.effectController.type;i.enable(n.toUpperCase()),i.enable("TOON"),i.enable("GLSL3"),t.uniforms=i.generateUniforms(),t.material=i.createMaterial(t.uniforms),t.material.defines=this.shaderDefines,this.resetParameters(t.uniforms),this.layers.push(t),t={},t.name="PolarConversion",t.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,t.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),i.clear(),i.enable("POLARCONVERSION"),t.uniforms=i.generateUniforms(),t.material=i.createMaterial(t.uniforms),t.material.defines=this.shaderDefines,this.layers.push(t),t={},t.name="ColorBalance",t.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,t.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),i.clear(),i.enable("COLORBALANCE"),t.uniforms=i.generateUniforms(),t.material=i.createMaterial(t.uniforms),t.material.defines=this.shaderDefines,this.layers.push(t),t={},t.name="Tiling",t.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,t.tDiffuse.wrapS=t.tDiffuse.wrapT=e.RepeatWrapping,t.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1}),i.clear(),i.enable("TILING"),t.uniforms=i.generateUniforms(),t.material=i.createMaterial(t.uniforms),t.material.defines=this.shaderDefines,this.layers.push(t),t={},t.name="NormalMap",t.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,t.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),i.clear(),i.enable("HEIGHT2NORMALSOBEL"),t.uniforms=i.generateUniforms(),t.material=i.createMaterial(t.uniforms),t.material.defines=this.shaderDefines,this.layers.push(t),t={},t.name="Copy",t.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,t.renderTarget=null,i.clear(),i.enable("COPY"),t.uniforms=i.generateUniforms(),t.material=i.createMaterial(t.uniforms),t.material.defines=this.shaderDefines,this.layers.push(t),this.spriteSheet.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1})},setupGui(){console.log("[fxgen] setup GUI...");const e=this,t=document.createElement("input");let i;t.type="file",t.addEventListener("change",(function(i){let n=new FileReader;n.addEventListener("load",(function(t){let i=t.target.result,n=JSON.parse(i);e.canvas.width=n.resolution,e.canvas.height=n.resolution,c();let r=new a.FxgenShader;for(var l in r.enable(n.type.toUpperCase()),r.enable("TOON"),r.enable("GLSL3"),e.layers[0].uniforms=r.generateUniforms(),e.layers[0].material=r.createMaterial(e.layers[0].uniforms,{defines:r.generateDefines()}),e.effectController.type=n.type,e.resetParameters(e.layers[0].uniforms),n)e.effectController[l]=n[l];for(var l in e.gui.root.controllers)e.gui.root.controllers[l].updateDisplay();for(var l in e.gui.pars.controllers)e.gui.pars.controllers[l].updateDisplay();for(var l in e.gui.tone.controllers)e.gui.tone.controllers[l].updateDisplay();for(var l in e.gui.tiling.controllers)e.gui.tiling.controllers[l].updateDisplay();for(var l in e.gui.normalMap.controllers)e.gui.normalMap.controllers[l].updateDisplay();for(var l in e.gui.cb.controllers)e.gui.cb.controllers[l].updateDisplay()}),!1),n.readAsText(t.files[0])})),t.addEventListener("click",(function(e){this.value=null})),this.effectController={saveImage(){e.render();let a=e.canvas.toDataURL();window.open("about:blank").document.write("<img src='"+a+"'/>")},savePng(){e.render(),e.updateSaveBuffer(),e.saveCanvas.toBlob((async function(e){const a=await window.showSaveFilePicker({types:[{description:"Images",accept:{"image/png":[".png"]}}],suggestedName:"image.png"}),t=await a.createWritable();await t.write(e),await t.close()}))},downloadPng(){const a=document.createElement("a");e.render(),e.updateSaveBuffer(),e.saveCanvas.toBlob((e=>{a.href=window.URL.createObjectURL(e),a.download="image.png",a.click()}))},saveSpriteSheet(){let a=Math.floor(e.canvas.width/e.spriteSheet.dimension)/e.canvas.width,t=e.spriteSheet.time;e.renderer.setRenderTarget(e.spriteSheet.renderTarget),e.renderer.clear(),e.renderer.setRenderTarget(null);for(let i=0;i<e.spriteSheet.dimension;i++)for(let n=0;n<e.spriteSheet.dimension;n++){let r=e.spriteSheet.timeStep*e.spriteSheet.dimension*i+e.spriteSheet.timeStep*n;if(r>=e.spriteSheet.timeLength)break;e.effectController.time=t+r,e.render(),e.spriteSheet.uniforms.tDiffuse.value=e.layers[e.layers.length-2].renderTarget.texture,e.spriteSheet.quad.scale.set(a,a,1),e.spriteSheet.quad.position.set(2*a*n-1+a,1-2*a*i-a,0),e.renderer.autoClear=!1,e.renderer.setRenderTarget(e.spriteSheet.renderTarget),e.renderer.render(e.spriteSheet.scene,e.spriteSheet.camera),e.renderer.setRenderTarget(null),e.renderer.autoClear=!0}e.spriteSheet.quad.scale.set(1,1,1),e.spriteSheet.quad.position.set(0,0,0),e.spriteSheet.uniforms.tDiffuse.value=e.spriteSheet.renderTarget.texture,e.renderer.render(e.spriteSheet.scene,e.spriteSheet.camera),e.effectController.time=t;let i=e.canvas.toDataURL();window.open("about:blank").document.write("<img src='"+i+"'/>")},resetColorBalance(){e.effectController.cColorBalanceShadowsR=0,e.effectController.cColorBalanceShadowsG=0,e.effectController.cColorBalanceShadowsB=0,e.effectController.cColorBalanceMidtonesR=0,e.effectController.cColorBalanceMidtonesG=0,e.effectController.cColorBalanceMidtonesB=0,e.effectController.cColorBalanceHighlightsR=0,e.effectController.cColorBalanceHighlightsG=0,e.effectController.cColorBalanceHighlightsB=0;for(let a in e.gui.cb.controllers)e.gui.cb.controllers[a].updateDisplay()},load(){t.click()},save(){let a;try{a=JSON.stringify(e.effectController,null,"\t"),a=a.replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(t){a=JSON.stringify(e.effectController)}var t;t="EffectTextureMaker_Untitled.json",function(e,a){o.href=URL.createObjectURL(e),o.download=a||"data.json",o.click()}(new Blob([a],{type:"text/plain"}),t)},animate:!1,time:0,resolution:"512",polarConversion:!1,cHeightScale:2,normalMap:!1,tiling:!1,cRadialMask:1,cFrequency:30,cAmplitude:.01,cIntensity:.5,cDirectionX:0,cDirectionY:1,cPowerExponent:1,cRadius:1,cInnerRadius:1,cInnerRadius2:1,cSize:1,cWidth:1,cHeight:1,cDepth:1,cColor:1,cRadius:.5,cPetals:6,cOffset:.2,cVolume:3,cBeta:4,cDelta:.05,cScale:1,cInnerWidth:.4,cStrength:1,cPower:1,cRange:2,cEmission:1,cBloom:1,cLightX:1,cLightY:1,cLightZ:1,cAmbient:1,cSmoothness:1,cSmoothnessPower:1,cThickness:1,cThicknessPower:1,cCameraTilt:0,cCameraPan:0,cSpeed:1,cAngle:0,cDensity:1,cAlpha:1,cDiamondGearTeeth:18,cDiamondGearMid:.8,cBrushStrokeX1:-.4,cBrushStrokeY1:0,cBrushStrokeX2:1.1,cBrushStrokeY2:.8,cBubblesVariation:1,cFlameEyeInnerFade:1,cFlameEyeOuterFade:1,cFlameEyeBorder:1,cSplatLines:20,cSplatSpotStep:.04,cTrabeculumVariation:2,cLifeTime:.9,cGravity:.26,cCount:300,cToonEnable:!1,cToonDark:.8,cToonLight:.95,cExplosionRadius:1.75,cExplosionDownScale:1.25,cExplosionGrain:2,cExplosionSpeed:.3,cExplosionBallness:2,cExplosionGrowth:2.2,cExplosionFade:1.6,cExplosionDensity:1.35,cExplosionContrast:1,cExplosionRollingInitDamp:.3,cExplosionRollingSpeed:2,cExplosionDelayRange:.25,cExplosionBallSpread:1,cExplosionBloom:0,cExplosionEmission:.2,cExplosionColor:1,cNoiseOctave:8,cNoiseFrequency:1,cNoiseAmplitude:.65,cNoisePersistence:.5,cNoiseScale:1,cNoiseSphereEnable:!1,cNoiseGraphEnable:!1,cNoiseStrength:1,cNoiseDepth:3,cNoiseSize:8,cColorBalanceShadowsR:0,cColorBalanceShadowsG:0,cColorBalanceShadowsB:0,cColorBalanceMidtonesR:0,cColorBalanceMidtonesG:0,cColorBalanceMidtonesB:0,cColorBalanceHighlightsR:0,cColorBalanceHighlightsG:0,cColorBalanceHighlightsB:0,type:"Wood"},this.gui.root=new n,this.gui.root.add(this.effectController,"load"),this.gui.root.add(this.effectController,"save"),i=this.gui.root,i.add(this.effectController,"resolution",["8","16","32","64","128","256","512","1024","2048"]).onChange((function(a){e.canvas.width=a,e.canvas.height=a,c()})),i.add(this.effectController,"type",["Wood","Circle","Solar","Corona","Spark","Ring","Gradation","GradationLine","Flash","Cone","Flower","FlowerFun","WaveRing","Smoke","Flame","FlameEye","Fire","Cell","Lightning","Flare","Flare2","Flare3","LensFlare","Sun","MagicCircle","Mandara","Explosion","Explosion2","Cross","Laser","Laser2","Light","Cloud","Cloud2","PerlinNoise","SeemlessNoise","BooleanNoise","CellNoise","TurbulentNoise","FbmNoise","FbmNoise2","FbmNoise3","RandomNoise","VoronoiNoise","SparkNoise","MarbleNoise","TessNoise","GradientNoise","Checker","FlameLance","Bonfire","Snow","DiamondGear","BrushStroke","Speckle","Bubbles","Pentagon","Grunge","Energy","InkSplat","Particle","Electric","Caustics","Squiggles","WaterTurbulence","Trabeculum"]).onChange((function(t){const i=new a.FxgenShader;i.enable(t.toUpperCase()),i.enable("TOON"),i.enable("GLSL3"),e.layers[0].uniforms=i.generateUniforms(),e.layers[0].material=i.createMaterial(e.layers[0].uniforms),e.layers[0].material.defines=i.generateDefines(),e.resetParameters(e.layers[0].uniforms)})),this.gui.root.add(this.effectController,"time",0,100),this.gui.root.add(this.effectController,"animate"),this.gui.pars=this.gui.root.addFolder("Parameters"),this.gui.parsItems=[],this.gui.root.add(this.effectController,"polarConversion"),i=this.gui.root.addFolder("Toon"),i.add(this.effectController,"cToonEnable").name("enable"),i.add(this.effectController,"cToonDark",0,1).name("dark"),i.add(this.effectController,"cToonLight",0,1).name("light"),i.open(!1),this.gui.tone=i,i=this.gui.root.addFolder("Tiling"),i.add(this.effectController,"tiling").name("enable"),i.add(this.effectController,"cRadialMask",0,1).name("radial mask"),i.open(!1),this.gui.tiling=i,i=this.gui.root.addFolder("NormalMap"),i.add(this.effectController,"normalMap").name("Generate"),i.add(this.effectController,"cHeightScale",0,10),i.open(!1),this.gui.normalMap=i,i=this.gui.root.addFolder("ColorBalance"),i.add(this.effectController,"cColorBalanceShadowsR",-1,1,.025).name("Shadows-R"),i.add(this.effectController,"cColorBalanceShadowsG",-1,1,.025).name("Shadows-G"),i.add(this.effectController,"cColorBalanceShadowsB",-1,1,.025).name("Shadows-B"),i.add(this.effectController,"cColorBalanceMidtonesR",-1,1,.025).name("Midtones-R"),i.add(this.effectController,"cColorBalanceMidtonesG",-1,1,.025).name("Midtones-G"),i.add(this.effectController,"cColorBalanceMidtonesB",-1,1,.025).name("Midtones-B"),i.add(this.effectController,"cColorBalanceHighlightsR",-1,1,.025).name("Highlights-R"),i.add(this.effectController,"cColorBalanceHighlightsG",-1,1,.025).name("Highlights-G"),i.add(this.effectController,"cColorBalanceHighlightsB",-1,1,.025).name("Highlights-B"),i.add(this.effectController,"resetColorBalance"),i.open(!1),this.gui.cb=i,i=this.gui.root.addFolder("SpriteSheet"),i.add(this.spriteSheet,"dimension",2,32).step(1),i.add(this.spriteSheet,"time",0,1e3),i.add(this.spriteSheet,"timeLength",.1,1e3),i.add(this.spriteSheet,"timeStep",1e-4,100),i.add(this.effectController,"saveSpriteSheet").name("Save (SpriteSheet)"),i.open(!1),this.alphaOptions.threshold=0,this.alphaOptions.tolerance=1,this.alphaOptions.blur=0,this.alphaOptions.visible=!1,this.alphaOptions.update=!1,i=this.gui.root.addFolder("Image with alpha (PNG)"),i.add(this.alphaOptions,"threshold",0,1).onChange((a=>{e.alphaOptions.update=!0})),i.add(this.alphaOptions,"tolerance",0,1).onChange((a=>{e.alphaOptions.update=!0})),i.add(this.alphaOptions,"blur",0,10,1).onChange((a=>{e.alphaOptions.update=!0})),i.add(this.alphaOptions,"visible").onChange((a=>{a?(e.canvas.style.display="none",e.alphaCanvas.style.display=null,e.alphaOptions.update=!0):(e.canvas.style.display=null,e.alphaCanvas.style.display="none")})),i.add(this.effectController,"savePng").name("Save (PNG)"),i.add(this.effectController,"downloadPng").name("Download (PNG)"),i.open(!1),this.gui.root.add(this.effectController,"saveImage").name("Save")},resetParameters(e){for(let e in this.gui.parsItems)this.gui.parsItems[e].destroy();this.gui.parsItems=[];for(let a in e){if("resolution"===a||"mouse"===a||"time"===a||"cameraPos"===a||"cameraDir"===a||"tDiffuse"===a||0===a.indexOf("toon")||a.indexOf("Enable")>=0)continue;const t=Object.keys(this.effectController);for(let a of t)a in e&&(this.effectController[a]=e[a].value)}let a={cFrequency:{minValue:0,maxValue:50,name:"Frequency"},cPowerExponent:{minValue:0,maxValue:5,name:"PowerExponent"},cAmplitude:{minValue:0,maxValue:.2,name:"Amplitude"},cIntensity:{minValue:0,maxValue:1,name:"Intensity",step:.01},cDirectionX:{minValue:-1,maxValue:1,name:"Direction X",step:.1},cDirectionY:{minValue:-1,maxValue:1,name:"Direction Y",step:.1},cRadius:{minValue:0,maxValue:2,name:"Radius",step:.01},cInnerRadius:{minValue:0,maxValue:2,name:"InnerRadius"},cInnerRadius2:{minValue:0,maxValue:2,name:"InnerRadius2"},cWidth:{minValue:0,maxValue:1,name:"Width",step:.01},cHeight:{minValue:0,maxValue:1,name:"Height"},cDepth:{minValue:0,maxValue:1,name:"Depth"},cOffset:{minValue:0,maxValue:1,name:"Offset",step:.1},cPetals:{minValue:1,maxValue:20,name:"Petals"},cVolume:{minValue:1,maxValue:10,name:"Volume"},cBeta:{minValue:1,maxValue:10,name:"Beta"},cDelta:{minValue:.01,maxValue:.2,name:"Delta"},cScale:{minValue:.1,maxValue:1,name:"Scale"},cSize:{minValue:.1,maxValue:5,name:"Size"},cColor:{minValue:0,maxValue:1,name:"Color",step:.1},cInnerWidth:{minValue:0,maxValue:1,name:"Inner Width"},cStrength:{minValue:0,maxValue:5,name:"Strength"},cPower:{minValue:0,maxValue:1,name:"Power"},cRange:{minValue:0,maxValue:5,name:"Range"},cEmission:{minValue:0,maxValue:1,name:"Emission"},cBloom:{minValue:0,maxValue:1,name:"Bloom",step:.1},cLightX:{minValue:-1,maxValue:1,name:"Light X",step:.01},cLightY:{minValue:-1,maxValue:1,name:"Light Y",step:.01},cLightZ:{minValue:-1,maxValue:1,name:"Light Z",step:.01},cAmbient:{minValue:0,maxValue:1,name:"Ambient"},cSmoothness:{minValue:0,maxValue:1,name:"Smoothness"},cSmoothnessPower:{minValue:1,maxValue:5,name:"Smoothness Power"},cThickness:{minValue:0,maxValue:1,name:"Thickness"},cThicknessPower:{minValue:1,maxValue:5,name:"Thickness Power"},cCameraTilt:{minValue:0,maxValue:1,name:"CameraTilt",step:.01},cCameraPan:{minValue:0,maxValue:1,name:"CameraPan",step:.01},cSpeed:{minValue:0,maxValue:10,name:"Speed"},cAngle:{minValue:0,maxValue:360,name:"Angle",step:.01},cDensity:{minValue:0,maxValue:1,name:"Density",step:.01},cAlpha:{minValue:0,maxValue:1,name:"Alpha",step:.01},cDiamondGearTeeth:{minValue:8,maxValue:32,name:"Teeth",step:1},cDiamondGearMid:{minValue:0,maxValue:1,name:"Mid",step:.01},cBrushStrokeX1:{minValue:-1,maxValue:1,name:"X1",step:.01},cBrushStrokeY1:{minValue:-1,maxValue:1,name:"Y1",step:.01},cBrushStrokeX2:{minValue:-1,maxValue:1,name:"X2",step:.01},cBrushStrokeY2:{minValue:-1,maxValue:1,name:"Y2",step:.01},cBubblesVariation:{minValue:1,maxValue:2,name:"Variation",step:1},cFlameEyeInnerFade:{minValue:.01,maxValue:1,name:"InnerFade",step:.01},cFlameEyeOuterFade:{minValue:.01,maxValue:1,name:"OuterFade",step:.01},cFlameEyeBorder:{minValue:.01,maxValue:1,name:"Border",step:.01},cSplatLines:{minValue:1,maxValue:100,name:"Lines"},cSplatSpotStep:{minValue:.02,maxValue:.1,name:"Spot Step",step:.02},cTrabeculumVariation:{minValue:0,maxValue:2,name:"Variation",step:1},cLifeTime:{minValue:0,maxValue:1,name:"Life Time",step:.01},cGravity:{minValue:0,maxValue:1,name:"Gravity",step:.01},cCount:{minValue:0,maxValue:500,name:"Count",step:1},cExplosionRadius:{minValue:1,maxValue:2,name:"Radius"},cExplosionDownScale:{minValue:1,maxValue:2,name:"DownScale"},cExplosionGrain:{minValue:1,maxValue:5,name:"Grain"},cExplosionSpeed:{minValue:.1,maxValue:2,name:"Speed"},cExplosionBallness:{minValue:2,maxValue:50,name:"Ballness"},cExplosionGrowth:{minValue:.1,maxValue:3,name:"Growth"},cExplosionFade:{minValue:1,maxValue:5,name:"Fade"},cExplosionDensity:{minValue:.1,maxValue:4,name:"Density"},cExplosionContrast:{minValue:.1,maxValue:4,name:"Contrast"},cExplosionRollingInitDamp:{minValue:.1,maxValue:2,name:"RollingInitDamp"},cExplosionRollingSpeed:{minValue:0,maxValue:4,name:"RollingSpeed"},cExplosionDelayRange:{minValue:.1,maxValue:2,name:"DelayRange"},cExplosionBallSpread:{minValue:.1,maxValue:5,name:"BallSpread"},cNoiseOctave:{minValue:1,maxValue:8,name:"NoiseOctave"},cNoiseFrequency:{minValue:0,maxValue:2,name:"NoiseFrequency",step:.01},cNoisePersistence:{minValue:0,maxValue:1,name:"NoisePersistence"},cNoiseAmplitude:{minValue:0,maxValue:1,name:"NoiseAmplitude",step:.01},cNoiseScale:{minValue:0,maxValue:1,name:"NoiseScale"},cNoiseSphereEnable:{name:"NoiseSphere"},cNoiseGraphEnable:{name:"NoiseGraph"},cNoiseSize:{minValue:.1,maxValue:10,name:"NoiseSize"},cNoiseStrength:{minValue:.1,maxValue:1,name:"NoiseStrength"},cNoiseDepth:{minValue:1,maxValue:5,name:"NoiseDepth"}};var t={Circle:{cPowerExponent:{minValue:0,maxValue:50}},Gradation:{cPowerExponent:{minValue:0,maxValue:50}},GradationLine:{cPowerExponent:{minValue:0,maxValue:50}},Cone:{cPowerExponent:{minValue:0,maxValue:50}},Cell:{cPowerExponent:{minValue:0,maxValue:50}},Flame:{cWidth:{minValue:.1,maxValue:2}},Lightning:{cFrequency:{minValue:0,maxValue:2},cWidth:{minValue:1,maxValue:10}},Cloud:{cCameraPan:{minValue:0,maxValue:1,defaultValue:0},cCameraTilt:{minValue:0,maxValue:1,defaultValue:0}},Checker:{cWidth:{minValue:1,maxValue:100},cHeight:{minValue:1,maxValue:100}},FbmNoise2:{cNoiseOctave:{minValue:1,maxValue:3,defaultValue:3},cNoiseAmplitude:{minValue:0,maxValue:.5,defaultValue:.25},cNoiseFrequency:{minValue:0,maxValue:1,defaultValue:1}},FbmNoise3:{cNoiseOctave:{minValue:1,maxValue:8,defaultValue:5},cNoiseAmplitude:{minValue:.5,maxValue:1.5,defaultValue:1},cNoiseFrequency:{minValue:0,maxValue:2,defaultValue:.5},cNoiseScale:{minValue:.01,maxValue:1}},MarbleNoise:{cScale:{minValue:1,maxValue:100},cFrequency:{minValue:1,maxValue:100}},TessNoise:{cNoiseFrequency:{minValue:0,maxValue:1,defaultValue:.1}},FlameEye:{cSpeed:{minValue:.1,maxValue:1}},FlameLance:{cSize:{minValue:1,maxValue:100},cSpeed:{minValue:.1,maxValue:5},cPower:{minValue:.1,maxValue:10},cAngle:{minValue:-1,maxValue:1}},Bonfire:{cSpeed:{minValue:.1,maxValue:1},cIntensity:{minValue:.1,maxValue:5},cStrength:{minValue:.1,maxValue:1},cDensity:{minValue:.1,maxValue:4},cSize:{minValue:0,maxValue:10}},Snow:{cDensity:{minValue:.1,maxValue:6},cRange:{minValue:.1,maxValue:1}},DiamondGear:{cWidth:{minValue:.1,maxValue:8}},BrushStroke:{cWidth:{minValue:0,maxValue:1,defaultValue:.3},cAlpha:{minValue:0,maxValue:1,defaultValue:.58},cStrength:{minValue:.1,maxValue:1,defaultValue:.6},cAngle:{minValue:0,maxValue:1},cAmplitude:{minValue:0,maxValue:1}},Speckle:{cRadius:{minValue:.01,maxValue:1,defaultValue:1},cDensity:{minValue:.01,maxValue:1,defaultValue:.1},cScale:{minValue:.01,maxValue:1,defaultValue:.01}},Pentagon:{cWidth:{minValue:.01,maxValue:1,defaultValue:.02},cScale:{minValue:.01,maxValue:1,defaultValue:.5},cAlpha:{minValue:.01,maxValue:1,defaultValue:.38}},Grunge:{cRadius:{minValue:.01,maxValue:1}},Energy:{cPower:{minValue:0,maxValue:1},cFrequency:{minValue:0,maxValue:1}},Particle:{cSize:{minValue:.01,maxValue:.5}},Electric:{cFrequency:{minValue:10,maxValue:50},cScale:{minValue:.01,maxValue:1}},Caustics:{cScale:{minValue:1,maxValue:10},cSpeed:{minValue:1,maxValue:4}},Squiggles:{cSize:{minValue:1,maxValue:8},cScale:{minValue:.01,maxValue:1,defaultValue:.5},cDensity:{minValue:1,maxValue:16}},WaterTurbulence:{cSize:{minValue:.01,maxValue:1,defaultValue:.4},cIntensity:{minValue:.01,maxValue:1,defaultValue:.15}},Trabeculum:{cDensity:{minValue:0,maxValue:1,defaultValue:1},cScale:{minValue:.01,maxValue:1,defaultValue:1},cCameraPan:{minValue:0,maxValue:1,defaultValue:.5},cCameraTilt:{minValue:0,maxValue:1,defaultValue:.5}}};let i={Wood:["cFrequency","cPowerExponent"],Circle:["cRadius","cPowerExponent"],Solar:["cIntensity","cPowerExponent"],Spark:["cIntensity","cPowerExponent"],Ring:["cRadius","cWidth","cPowerExponent"],Gradation:["cDirectionX","cDirectionY","cPowerExponent"],GradationLine:["cDirectionX","cDirectionY","cOffset","cPowerExponent"],Flash:["cFrequency","cPowerExponent"],Cone:["cDirectionX","cDirectionY","cPowerExponent"],Flower:["cPetals","cRadius","cIntensity","cPowerExponent"],FlowerFun:["cPetals","cRadius","cOffset","cIntensity","cPowerExponent"],WaveRing:["cRadius","cWidth","cFrequency","cAmplitude","cPowerExponent"],Flame:["cIntensity","cWidth","cScale"],FlameEye:["cSpeed","cFlameEyeInnerFade","cFlameEyeOuterFade","cFlameEyeBorder","cColor"],Cell:["cIntensity","cPowerExponent","cSize"],Smoke:["cVolume","cBeta","cDelta"],Lightning:["cIntensity","cFrequency","cWidth"],Flare:["cIntensity","cPowerExponent"],Flare2:["cIntensity","cPowerExponent"],Flare3:["cIntensity","cPowerExponent"],MagicCircle:[],Mandara:["cRadius","cInnerRadius","cInnerRadius2"],Cross:["cIntensity","cPowerExponent"],Explosion:["cCameraTilt","cCameraPan","cExplosionRadius","cExplosionDownScale","cExplosionGrain","cExplosionSpeed","cExplosionBallness","cExplosionGrowth","cExplosionFade","cExplosionDensity","cExplosionContrast","cExplosionRollingInitDamp","cExplosionRollingSpeed","cExplosionDelayRange","cExplosionBallSpread"],Explosion2:["cCameraPan","cExplosionSpeed","cExplosionDensity","cEmission","cBloom","cColor"],Corona:["cIntensity","cRadius","cSize"],Fire:["cIntensity","cStrength","cPower","cRange","cWidth","cColor"],LensFlare:["cRadius","cRange","cColor","cPowerExponent"],Sun:["cRadius","cColor"],Laser:["cWidth","cColor"],Laser2:["cWidth","cInnerWidth"],Light:["cRadius","cPowerExponent","cColor"],Cloud:["cWidth","cHeight","cDepth","cIntensity","cLightX","cLightY","cLightZ","cAmbient","cSmoothness","cSmoothnessPower","cThickness","cThicknessPower","cCameraTilt","cCameraPan"],Cloud2:["cIntensity","cDensity","cThickness","cColor"],PerlinNoise:["cNoiseOctave","cNoisePersistence","cNoiseSphereEnable","cNoiseGraphEnable"],SeemlessNoise:["cNoiseOctave","cNoisePersistence","cNoiseScale","cNoiseSphereEnable","cNoiseGraphEnable"],BooleanNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],CellNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],RandomNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],FbmNoise:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],FbmNoise2:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cScale","cNoiseSphereEnable","cNoiseGraphEnable"],FbmNoise3:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cNoiseScale","cOffset","cNoiseSphereEnable","cNoiseGraphEnable"],TurbulentNoise:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],SparkNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],VoronoiNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],MarbleNoise:["cScale","cFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],TessNoise:["cNoiseFrequency","cOffset","cNoiseSphereEnable","cNoiseGraphEnable"],GradientNoise:["cNoiseScale","cColor","cNoiseSphereEnable","cNoiseGraphEnable"],Checker:["cWidth","cHeight"],FlameLance:["cSize","cSpeed","cPower","cAngle","cColor","cNoiseSize","cNoiseStrength","cNoiseDepth"],Bonfire:["cSpeed","cIntensity","cStrength","cDensity","cSize","cColor"],Snow:["cSpeed","cScale","cDensity","cRange"],DiamondGear:["cScale","cWidth","cRadius","cDiamondGearTeeth","cDiamondGearMid"],BrushStroke:["cWidth","cStrength","cAlpha","cAngle","cAmplitude","cBrushStrokeX1","cBrushStrokeY1","cBrushStrokeX2","cBrushStrokeY2","cColor"],Speckle:["cRadius","cScale","cDensity"],Bubbles:["cRadius","cWidth","cThickness","cColor","cBubblesVariation"],Pentagon:["cScale","cAlpha","cWidth"],Grunge:["cRadius","cScale"],Energy:["cPower","cDensity","cThickness","cScale","cFrequency","cColor"],InkSplat:["cSplatLines","cSplatSpotStep"],Particle:["cSize","cLifeTime","cGravity","cCount"],Electric:["cFrequency","cScale"],Caustics:["cScale","cSpeed","cColor"],Squiggles:["cSize","cScale","cDensity"],WaterTurbulence:["cScale","cIntensity"],Trabeculum:["cDensity","cScale","cIntensity","cTrabeculumVariation","cCameraTilt","cCameraPan","cColor"],Test:[]}[this.effectController.type];for(let e=0;e<i.length;e++){let r=a[i[e]];if(i[e].indexOf("Enable")>=0)this.gui.parsItems.push(this.gui.pars.add(this.effectController,i[e]).name(r.name));else{let a=!1;if(this.effectController.type in t&&i[e]in t[this.effectController.type]&&(a=!0),a){let n=t[this.effectController.type][i[e]];"defaultValue"in n&&(this.effectController[i[e]]=n.defaultValue);let l=this.gui.pars.add(this.effectController,i[e],n.minValue,n.maxValue).name(r.name);"step"in r&&l.step(r.step),"step"in n&&l.step(a.step),this.gui.parsItems.push(l)}else{var n=this.gui.pars.add(this.effectController,i[e],r.minValue,r.maxValue).name(r.name);"step"in r&&n.step(r.step),this.gui.parsItems.push(n)}}}},updateSaveBuffer(){this.saveCanvas.width=this.canvas.width,this.saveCanvas.height=this.canvas.height;const e=this.saveCanvas.getContext("2d",{willReadFrequently:!0});if(this.alphaOptions.blur>0){this.blur50.width=.5*this.canvas.width,this.blur50.height=.5*this.canvas.height,this.blur25.width=.25*this.canvas.width,this.blur25.height=.25*this.canvas.height;let a=this.blur50,t=this.blur25,i=a.getContext("2d"),n=t.getContext("2d");n.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,t.width,t.height),i.drawImage(t,0,0,t.width,t.height,0,0,a.width,a.height);for(let e=0;e<this.alphaOptions.blur;e++)n.drawImage(a,0,0,a.width,a.height,0,0,t.width,t.height),i.drawImage(t,0,0,t.width,t.height,0,0,a.width,a.height),[a,t,i,n]=[t,a,n,i];e.drawImage(a,0,0,a.width,a.height,0,0,this.canvas.width,this.canvas.height)}else e.drawImage(this.canvas,0,0);const a=Math.round(255*this.alphaOptions.threshold),t=Math.round(255*this.alphaOptions.tolerance),i=e.getImageData(0,0,this.canvas.width,this.canvas.height);let n=i.data;for(let e=0;e<n.length;e+=4){const i=n[e+0]>t?255:n[e+0]<a?0:n[e+0],r=n[e+1]>t?255:n[e+1]<a?0:n[e+1],l=n[e+2]>t?255:n[e+2]<a?0:n[e+2],s=Math.round(Math.max(i,r,l));n[e+3]=s}i.data.set(n),e.putImageData(i,0,0)},updateAlphaBuffer(){this.updateSaveBuffer(),this.alphaCanvas.width=this.canvas.width,this.alphaCanvas.height=this.canvas.height;const e=this.alphaCanvas.getContext("2d",{willReadFrequently:!0});e.drawImage(this.saveCanvas,0,0);const a=e.getImageData(0,0,this.canvas.width,this.canvas.height),t=a.data;for(let e=0;e<t.length;e+=4)t[e+0]=t[e+1]=t[e+2]=t[e+3],t[e+3]=255;a.data.set(t),e.putImageData(a,0,0)},animate(){this.effectController.animate&&(this.effectController.time+=this.clock.getDelta());var e=this.effectController.time,a=e.toString()+"0000000";0===e&&(a="0.00000000"),document.getElementById("time").innerHTML=a.substr(0,8),requestAnimationFrame(this.animate.bind(this)),this.render(),this.alphaOptions.visible&&(this.effectController.animate||this.alphaOptions.update)&&this.updateAlphaBuffer()},render(){this.stats.update();for(var t=0;t<this.layers.length;t++){var i=this.layers[t],n=i.renderTarget,r=i.tDiffuse;"NormalMap"===i.name&&!1===this.effectController.normalMap&&(i=this.layers[this.layers.length-1]),"PolarConversion"===i.name&&!1===this.effectController.polarConversion&&(i=this.layers[this.layers.length-1]),"Tiling"===i.name&&!1===this.effectController.tiling&&(i=this.layers[this.layers.length-1]),i.uniforms.resolution.value=new e.Vector2(this.canvas.width,this.canvas.height),this.camera.getWorldPosition(i.uniforms.cameraPos.value),this.camera.getWorldDirection(i.uniforms.cameraDir.value),i.uniforms.mouse.value.copy(this.mouse),i.uniforms.tDiffuse.value=r;const l=Object.keys(this.effectController);for(let e in l){const t=l[e];"resolution"!==t&&a.FxgenShaderUtils.SetShaderParameter(i.uniforms,t,this.effectController[t])}a.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cColorBalanceShadows",new e.Vector3(this.effectController.cColorBalanceShadowsR,this.effectController.cColorBalanceShadowsG,this.effectController.cColorBalanceShadowsB)),a.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cColorBalanceMidtones",new e.Vector3(this.effectController.cColorBalanceMidtonesR,this.effectController.cColorBalanceMidtonesG,this.effectController.cColorBalanceMidtonesB)),a.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cColorBalanceHighlights",new e.Vector3(this.effectController.cColorBalanceHighlightsR,this.effectController.cColorBalanceHighlightsG,this.effectController.cColorBalanceHighlightsB)),a.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cDirection",new e.Vector2(this.effectController.cDirectionX,this.effectController.cDirectionY)),a.FxgenShaderUtils.SetShaderParameter(i.uniforms,"tGrunge",this.grungeTexture),this.scene.overrideMaterial=i.material,this.renderer.setRenderTarget(n),this.renderer.render(this.scene,this.dummyCamera),this.renderer.setRenderTarget(null),this.scene.overrideMaterial=null}this.effectController.cNoiseSphereEnable&&(this.noise.uniforms.tDisplacement.value=this.layers[this.layers.length-2].renderTarget.texture,this.renderer.render(this.noise.scene,this.camera))}},o=document.createElement("a");function c(){if(console.log("[fxgen] onWindowResize"),s.renderer.setSize(s.canvas.width,s.canvas.height),s.layers)for(var a=0;a<s.layers.length;a++)s.layers[a].renderTarget&&(s.layers[a].renderTarget=new e.WebGLRenderTarget(s.canvas.width,s.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1})),s.layers[a].tDiffuse&&(s.layers[a].tDiffuse=s.layers[a-1].renderTarget.texture),"Tiling"===s.layers[a].name&&(s.layers[a].tDiffuse.wrapS=s.layers[a].tDiffuse.wrapT=e.RepeatWrapping);s.spriteSheet.renderTarget=new e.WebGLRenderTarget(s.canvas.width,s.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),s.render()}o.style.display="none",document.body.appendChild(o),s.init(),s.animate(),window.addEventListener("resize",c,!1),console.log("[fxgen] ready");
