import*as e from"three";import*as t from"pixy";import a from"three/addons/capabilities/WebGL.js";import i from"three/addons/libs/stats.module.js";import{GUI as n}from"three/addons/libs/lil-gui.module.min.js";import{CopyShader as l}from"three/addons/shaders/CopyShader.js";import{OrbitControls as r}from"three/addons/controls/OrbitControls.js";!1===a.isWebGLAvailable()&&document.body.appendChild(a.getWebGLErrorMessage());const s={mouse:new e.Vector2(.5,.5),canvas:void 0,camera:void 0,dummyCamera:void 0,controls:void 0,scene:void 0,renderer:void 0,noise:{scene:void 0,sphere:void 0,uniforms:void 0,material:void 0,texture:void 0},grungeTexture:void 0,gui:{root:void 0,tiling:void 0,tone:void 0,normalMap:void 0,cb:void 0,pars:void 0,parsItems:void 0},stats:void 0,clock:new e.Clock,effectController:void 0,layers:[],spriteSheet:{},alphaOptions:{},shaderDefines:void 0,preventSave:!1,init(){this.initGraphics(),this.initScene(),this.setupGui(),this.initLayers(),console.log("[fxgen] initialized")},initGraphics(){console.log("[fxgen] initializing graphics..."),
//! RENDERER
this.renderer=new e.WebGLRenderer,this.renderer.setSize(512,512),this.renderer.capabilities.isWebGL2&&console.log("[fxgen] WebGL2"),this.canvas=this.renderer.domElement,this.canvas.addEventListener("mousemove",(e=>{this.mouse.x=e.offsetX/this.canvas.width,this.mouse.y=e.offsetY/this.canvas.height})),document.body.appendChild(this.canvas),this.alphaCanvas=document.createElement("canvas"),this.alphaCanvas.style.display="none",document.body.appendChild(this.alphaCanvas),this.saveCanvas=document.createElement("canvas"),this.blur50=document.createElement("canvas"),this.blur25=document.createElement("canvas"),
//! STATS
this.stats=new i,document.body.appendChild(this.stats.dom)},initScene(){
//! TEXTUERS
//! MATERIALS
//! MODELS
let a,i,n;console.log("[fxgen] initializing scene..."),this.scene=new e.Scene,this.noise.scene=new e.Scene,
//! CAMERA
this.camera=new e.PerspectiveCamera(45,1,1,1e3),this.camera.position.set(0,0,3.8),this.dummyCamera=new e.Camera,
//! CONTROLS
this.controls=new r(this.camera,this.renderer.domElement),this.controls.target.set(0,0,0),this.controls.addEventListener("change",this.render.bind(this)),a=new e.PlaneGeometry(2,2),i=new e.Mesh(a,new e.MeshBasicMaterial),this.scene.add(i),
//! TEXTUER MAP
this.grungeTexture=(new e.TextureLoader).load("images/grunge.png"),this.grungeTexture.wrapS=this.grungeTexture.wrapT=e.RepeatWrapping,this.grungeTexture.minFilter=e.LinearFilter,this.grungeTexture.magFilter=e.LinearFilter,this.grungeTexture.anisotropy=16,a=new e.SphereGeometry(1,1024,1024),n=new t.FxgenShader,n.enable("DISPLACEMENT"),this.noise.uniforms=n.generateUniforms(),this.noise.material=n.createStandardMaterial(this.noise.uniforms),this.noise.sphere=new e.Mesh(a,this.noise.material),this.noise.scene.add(this.noise.sphere),
//! LAYERS
n=new t.FxgenShader,this.shaderDefines=n.generateDefines(),this.spriteSheet.uniforms=e.UniformsUtils.clone(l.uniforms),this.spriteSheet.material=new e.ShaderMaterial({uniforms:this.spriteSheet.uniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,depthTest:!1,depthWrite:!1}),this.spriteSheet.uniforms.opacity.value=1,this.spriteSheet.camera=new e.OrthographicCamera(-1,1,1,-1,0,1),this.spriteSheet.scene=new e.Scene,this.spriteSheet.quad=new e.Mesh(new e.PlaneGeometry(2,2),this.spriteSheet.material),this.spriteSheet.dimension=8,this.spriteSheet.time=0,this.spriteSheet.timeLength=3,this.spriteSheet.timeStep=.1,this.spriteSheet.scene.add(this.spriteSheet.quad)},initLayers(){console.log("[fxgen] initializing layers..."),this.layers=[];let a={name:"Base"};a.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1});let i=new t.FxgenShader,n=this.effectController.type;i.enable(n.toUpperCase()),i.enable("TOON"),i.enable("GLSL3"),a.uniforms=i.generateUniforms(),a.defaultUniforms=e.UniformsUtils.clone(a.uniforms),a.material=i.createMaterial(a.uniforms),a.material.defines=this.shaderDefines,this.resetParameters(a.defaultUniforms),this.layers.push(a),
//! POLAR CONVERSION
a={},a.name="PolarConversion",a.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,a.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),i.clear(),i.enable("POLARCONVERSION"),a.uniforms=i.generateUniforms(),a.material=i.createMaterial(a.uniforms),a.material.defines=this.shaderDefines,this.layers.push(a),
//! COLOR BALANCE
a={},a.name="ColorBalance",a.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,a.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),i.clear(),i.enable("COLORBALANCE"),a.uniforms=i.generateUniforms(),a.material=i.createMaterial(a.uniforms),a.material.defines=this.shaderDefines,this.layers.push(a),
//! TILING
a={},a.name="Tiling",a.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,a.tDiffuse.wrapS=a.tDiffuse.wrapT=e.RepeatWrapping,a.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.NearestFilter,magFilter:e.NearestFilter,stencilBuffer:!1}),i.clear(),i.enable("TILING"),a.uniforms=i.generateUniforms(),a.material=i.createMaterial(a.uniforms),a.material.defines=this.shaderDefines,this.layers.push(a),
//! NORMAL MAP
a={},a.name="NormalMap",a.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,a.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),i.clear(),i.enable("HEIGHT2NORMALSOBEL"),a.uniforms=i.generateUniforms(),a.material=i.createMaterial(a.uniforms),a.material.defines=this.shaderDefines,this.layers.push(a),
//! COPY
a={},a.name="Copy",a.tDiffuse=this.layers[this.layers.length-1].renderTarget.texture,a.renderTarget=null,i.clear(),i.enable("COPY"),a.uniforms=i.generateUniforms(),a.material=i.createMaterial(a.uniforms),a.material.defines=this.shaderDefines,this.layers.push(a),this.spriteSheet.renderTarget=new e.WebGLRenderTarget(this.canvas.width,this.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1})},setupGui(){let a;console.log("[fxgen] setup GUI..."),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.addEventListener("change",(a=>{let i=new FileReader;i.addEventListener("load",(a=>{let i=a.target.result,n=JSON.parse(i);this.canvas.width=n.resolution,this.canvas.height=n.resolution,c();let l=new t.FxgenShader;l.enable(n.type.toUpperCase()),l.enable("TOON"),l.enable("GLSL3"),this.layers[0].uniforms=l.generateUniforms(),this.layers[0].defaultUniforms=e.UniformsUtils.clone(this.layers[0].uniforms),this.layers[0].material=l.createMaterial(this.layers[0].uniforms,{defines:l.generateDefines()}),this.effectController.type=n.type,this.resetParameters(this.layers[0].defaultUniforms);for(let e in n)this.effectController[e]=n[e];for(let e in this.gui.root.controllers)this.gui.root.controllers[e].updateDisplay();for(let e in this.gui.pars.controllers)this.gui.pars.controllers[e].updateDisplay();for(let e in this.gui.tone.controllers)this.gui.tone.controllers[e].updateDisplay();for(let e in this.gui.tiling.controllers)this.gui.tiling.controllers[e].updateDisplay();for(let e in this.gui.normalMap.controllers)this.gui.normalMap.controllers[e].updateDisplay();for(let e in this.gui.cb.controllers)this.gui.cb.controllers[e].updateDisplay()}),!1),i.readAsText(this.fileInput.files[0])})),this.fileInput.addEventListener("click",(e=>{this.value=null})),this.effectController={animate:!1,time:0,resolution:"512",polarConversion:!1,cHeightScale:2,normalMap:!1,tiling:!1,cRadialMask:1,cColorBalanceShadowsR:0,cColorBalanceShadowsG:0,cColorBalanceShadowsB:0,cColorBalanceMidtonesR:0,cColorBalanceMidtonesG:0,cColorBalanceMidtonesB:0,cColorBalanceHighlightsR:0,cColorBalanceHighlightsG:0,cColorBalanceHighlightsB:0,type:"Wood"},this.resetEffectParameters(),this.gui.root=new n,this.gui.root.add(this,"load"),this.gui.root.add(this,"save"),a=this.gui.root,a.add(this.effectController,"resolution",["8","16","32","64","128","256","512","1024","2048"]).onChange((e=>{this.canvas.width=e,this.canvas.height=e,c()})),a.add(this.effectController,"type",["Wood","Circle","Solar","Corona","Spark","Ring","Gradation","GradationLine","Flash","Cone","Flower","FlowerFun","WaveRing","Smoke","Flame","FlameEye","Fire","Cell","Lightning","Flare","Flare2","Flare3","LensFlare","Sun","MagicCircle","Mandara","Explosion","Explosion2","Cross","Laser","Laser2","Light","Cloud","Cloud2","CoherentNoise","PerlinNoise","SeemlessNoise","BooleanNoise","CellNoise","TurbulentNoise","FbmNoise","FbmNoise2","FbmNoise3","RandomNoise","VoronoiNoise","SparkNoise","MarbleNoise","TessNoise","GradientNoise","Checker","FlameLance","Bonfire","Snow","DiamondGear","BrushStroke","Speckle","Bubbles","Pentagon","Grunge","Energy","InkSplat","Particle","Electric","Caustics","Squiggles","WaterTurbulence","Trabeculum","BinaryMatrix"]).onChange((a=>{const i=new t.FxgenShader;i.enable(a.toUpperCase()),i.enable("TOON"),i.enable("GLSL3"),this.layers[0].uniforms=i.generateUniforms(),this.layers[0].defaultUniforms=e.UniformsUtils.clone(this.layers[0].uniforms),this.layers[0].material=i.createMaterial(this.layers[0].uniforms),this.layers[0].material.defines=i.generateDefines(),this.resetParameters(this.layers[0].defaultUniforms)})),this.gui.root.add(this.effectController,"time",0,100),this.gui.root.add(this.effectController,"animate"),this.gui.pars=this.gui.root.addFolder("Parameters"),this.gui.pars.add(this,"onResetEffectParameters").name("reset"),this.gui.parsItems=[],this.gui.root.add(this.effectController,"polarConversion"),a=this.gui.root.addFolder("Toon"),a.add(this.effectController,"cToonEnable").name("enable"),a.add(this.effectController,"cToonDark",0,1).name("dark"),a.add(this.effectController,"cToonLight",0,1).name("light"),a.open(!1),this.gui.tone=a,a=this.gui.root.addFolder("Tiling"),a.add(this.effectController,"tiling").name("enable"),a.add(this.effectController,"cRadialMask",0,1).name("radial mask"),a.open(!1),this.gui.tiling=a,a=this.gui.root.addFolder("NormalMap"),a.add(this.effectController,"normalMap").name("Generate"),a.add(this.effectController,"cHeightScale",0,10),a.open(!1),this.gui.normalMap=a,a=this.gui.root.addFolder("ColorBalance"),a.add(this.effectController,"cColorBalanceShadowsR",-1,1,.025).name("Shadows-R"),a.add(this.effectController,"cColorBalanceShadowsG",-1,1,.025).name("Shadows-G"),a.add(this.effectController,"cColorBalanceShadowsB",-1,1,.025).name("Shadows-B"),a.add(this.effectController,"cColorBalanceMidtonesR",-1,1,.025).name("Midtones-R"),a.add(this.effectController,"cColorBalanceMidtonesG",-1,1,.025).name("Midtones-G"),a.add(this.effectController,"cColorBalanceMidtonesB",-1,1,.025).name("Midtones-B"),a.add(this.effectController,"cColorBalanceHighlightsR",-1,1,.025).name("Highlights-R"),a.add(this.effectController,"cColorBalanceHighlightsG",-1,1,.025).name("Highlights-G"),a.add(this.effectController,"cColorBalanceHighlightsB",-1,1,.025).name("Highlights-B"),a.add(this,"onResetColorBalance").name("reset"),a.open(!1),this.gui.cb=a,a=this.gui.root.addFolder("SpriteSheet"),a.add(this.spriteSheet,"dimension",2,32).step(1),a.add(this.spriteSheet,"time",0,1e3),a.add(this.spriteSheet,"timeLength",.1,1e3),a.add(this.spriteSheet,"timeStep",1e-4,100),a.add(this,"onSaveSpriteSheet").name("Save (SpriteSheet)"),a.add(this,"onSaveSpriteSheetPng").name("Save (SpriteSheet with alpha)"),a.add(this,"onDownloadSpriteSheetPng").name("Download (SpriteSheet with alpha)"),a.open(!1),this.alphaOptions.threshold=0,this.alphaOptions.tolerance=1,this.alphaOptions.blur=0,this.alphaOptions.visible=!1,this.alphaOptions.update=!1,a=this.gui.root.addFolder("Image with alpha (PNG)"),a.add(this.alphaOptions,"threshold",0,1).onChange((e=>{this.alphaOptions.update=!0})),a.add(this.alphaOptions,"tolerance",0,1).onChange((e=>{this.alphaOptions.update=!0})),a.add(this.alphaOptions,"blur",0,10,1).onChange((e=>{this.alphaOptions.update=!0})),a.add(this.alphaOptions,"visible").onChange((e=>{e?(this.canvas.style.display="none",this.alphaCanvas.style.display=null,this.alphaOptions.update=!0):(this.canvas.style.display=null,this.alphaCanvas.style.display="none")})),a.add(this,"onSavePng").name("Save (PNG)"),a.add(this,"onDownloadPng").name("Download (PNG)"),a.open(!1),this.gui.root.add(this,"onSaveImage").name("Save")},resetEffectParameters(){this.effectController.cFrequency=30,this.effectController.cAmplitude=.01,this.effectController.cIntensity=.5,this.effectController.cDirectionX=0,this.effectController.cDirectionY=1,this.effectController.cPowerExponent=1,this.effectController.cRadius=1,this.effectController.cInnerRadius=1,this.effectController.cInnerRadius2=1,this.effectController.cSize=1,this.effectController.cWidth=1,this.effectController.cHeight=1,this.effectController.cDepth=1,this.effectController.cColor=1,this.effectController.cRadius=.5,this.effectController.cPetals=6,this.effectController.cOffset=.2,this.effectController.cVolume=3,this.effectController.cBeta=4,this.effectController.cDelta=.05,this.effectController.cScale=1,this.effectController.cInnerWidth=.4,this.effectController.cStrength=1,this.effectController.cPower=1,this.effectController.cRange=2,this.effectController.cEmission=1,this.effectController.cBloom=1,this.effectController.cLightX=1,this.effectController.cLightY=1,this.effectController.cLightZ=1,this.effectController.cAmbient=1,this.effectController.cSmoothness=1,this.effectController.cSmoothnessPower=1,this.effectController.cThickness=1,this.effectController.cThicknessPower=1,this.effectController.cCameraTilt=0,this.effectController.cCameraPan=0,this.effectController.cSpeed=1,this.effectController.cAngle=0,this.effectController.cDensity=1,this.effectController.cAlpha=1,this.effectController.cRepeat=1,this.effectController.cScaleShift=0,this.effectController.cBias=0,this.effectController.cGain=0,this.effectController.cInvert=0,this.effectController.cThreshold=0,this.effectController.cDiamondGearTeeth=18,this.effectController.cDiamondGearMid=.8,this.effectController.cBrushStrokeX1=-.4,this.effectController.cBrushStrokeY1=0,this.effectController.cBrushStrokeX2=1.1,this.effectController.cBrushStrokeY2=.8,this.effectController.cBubblesVariation=1,this.effectController.cFlameEyeInnerFade=1,this.effectController.cFlameEyeOuterFade=1,this.effectController.cFlameEyeBorder=1,this.effectController.cSplatLines=20,this.effectController.cSplatSpotStep=.04,this.effectController.cTrabeculumVariation=2,this.effectController.cLifeTime=.9,this.effectController.cGravity=.26,this.effectController.cCount=300,this.effectController.cToonEnable=!1,this.effectController.cToonDark=.8,this.effectController.cToonLight=.95,this.effectController.cExplosionRadius=1.75,this.effectController.cExplosionDownScale=1.25,this.effectController.cExplosionGrain=2,this.effectController.cExplosionSpeed=.3,this.effectController.cExplosionBallness=2,this.effectController.cExplosionGrowth=2.2,this.effectController.cExplosionFade=1.6,this.effectController.cExplosionDensity=1.35,this.effectController.cExplosionContrast=1,this.effectController.cExplosionRollingInitDamp=.3,this.effectController.cExplosionRollingSpeed=2,this.effectController.cExplosionDelayRange=.25,this.effectController.cExplosionBallSpread=1,this.effectController.cExplosionBloom=0,this.effectController.cExplosionEmission=.2,this.effectController.cExplosionColor=1,this.effectController.cNoiseOctave=8,this.effectController.cNoiseFrequency=1,this.effectController.cNoiseAmplitude=.65,this.effectController.cNoisePersistence=.5,this.effectController.cNoiseScale=1,this.effectController.cNoiseSphereEnable=!1,this.effectController.cNoiseGraphEnable=!1,this.effectController.cNoiseStrength=1,this.effectController.cNoiseDepth=3,this.effectController.cNoiseSize=8,this.effectController.cNoiseLacunarity=2,this.effectController.cTurbulence=0,this.effectController.cRidge=0,this.effectController.cRidgeOffset=.9,this.effectController.cGradientNoise=0,this.effectController.cValueNoise=0,this.effectController.cVoronoiNoise=0,this.effectController.cVoronoiCell=0,this.effectController.cSimplexNoise=1},onResetEffectParameters(){this.resetEffectParameters(),this.resetParameters(this.layers[0].defaultUniforms)},onSaveImage(){this.render();let e=this.canvas.toDataURL();window.open("about:blank").document.write("<img src='"+e+"'/>")},onSavePng(){this.render(),this.updateSaveBuffer(),this.saveCanvas.toBlob((async function(e){const t=await window.showSaveFilePicker({types:[{description:"Images",accept:{"image/png":[".png"]}}],suggestedName:"image.png"}),a=await t.createWritable();await a.write(e),await a.close()}))},onDownloadPng(){this.render(),this.updateSaveBuffer(),this.saveCanvas.toBlob((e=>{const t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download="image.png",t.click()}))},onSaveSpriteSheet(){let e=Math.floor(this.canvas.width/this.spriteSheet.dimension)/this.canvas.width,t=this.spriteSheet.time;this.renderer.setRenderTarget(this.spriteSheet.renderTarget),this.renderer.clear(),this.renderer.setRenderTarget(null);for(let a=0;a<this.spriteSheet.dimension;a++)for(let i=0;i<this.spriteSheet.dimension;i++){let n=this.spriteSheet.timeStep*this.spriteSheet.dimension*a+this.spriteSheet.timeStep*i;if(n>=this.spriteSheet.timeLength)break;this.effectController.time=t+n,this.render(),this.spriteSheet.uniforms.tDiffuse.value=this.layers[this.layers.length-2].renderTarget.texture,this.spriteSheet.quad.scale.set(e,e,1),this.spriteSheet.quad.position.set(2*e*i-1+e,1-2*e*a-e,0),this.renderer.autoClear=!1,this.renderer.setRenderTarget(this.spriteSheet.renderTarget),this.renderer.render(this.spriteSheet.scene,this.spriteSheet.camera),this.renderer.setRenderTarget(null),this.renderer.autoClear=!0}if(this.spriteSheet.quad.scale.set(1,1,1),this.spriteSheet.quad.position.set(0,0,0),this.spriteSheet.uniforms.tDiffuse.value=this.spriteSheet.renderTarget.texture,this.renderer.render(this.spriteSheet.scene,this.spriteSheet.camera),this.effectController.time=t,!this.preventSave){let e=this.canvas.toDataURL();window.open("about:blank").document.write("<img src='"+e+"'/>")}},onSaveSpriteSheetPng(){this.preventSave=!0,this.onSaveSpriteSheet(),this.preventSave=!1,this.updateSaveBuffer(),this.saveCanvas.toBlob((async function(e){const t=await window.showSaveFilePicker({types:[{description:"Images",accept:{"image/png":[".png"]}}],suggestedName:"image.png"}),a=await t.createWritable();await a.write(e),await a.close()}))},onDownloadSpriteSheetPng(){this.preventSave=!0,this.onSaveSpriteSheet(),this.preventSave=!1,this.updateSaveBuffer(),this.saveCanvas.toBlob((e=>{const t=document.createElement("a");t.href=window.URL.createObjectURL(e),t.download="image.png",t.click()}))},onResetColorBalance(){this.effectController.cColorBalanceShadowsR=0,this.effectController.cColorBalanceShadowsG=0,this.effectController.cColorBalanceShadowsB=0,this.effectController.cColorBalanceMidtonesR=0,this.effectController.cColorBalanceMidtonesG=0,this.effectController.cColorBalanceMidtonesB=0,this.effectController.cColorBalanceHighlightsR=0,this.effectController.cColorBalanceHighlightsG=0,this.effectController.cColorBalanceHighlightsB=0;for(let e in this.gui.cb.controllers)this.gui.cb.controllers[e].updateDisplay()},load(){this.fileInput.click()},save(){let e;try{e=JSON.stringify(this.effectController,null,"\t"),e=e.replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(t){e=JSON.stringify(this.effectController)}var t;t="EffectTextureMaker_Untitled.json",function(e,t){o.href=URL.createObjectURL(e),o.download=t||"data.json",o.click()}(new Blob([e],{type:"text/plain"}),t)},resetParameters(e){for(let e in this.gui.parsItems)this.gui.parsItems[e].destroy();this.gui.parsItems=[];let t={cFrequency:{minValue:0,maxValue:50,name:"Frequency"},cPowerExponent:{minValue:0,maxValue:5,name:"PowerExponent"},cAmplitude:{minValue:0,maxValue:.2,name:"Amplitude"},cIntensity:{minValue:0,maxValue:1,name:"Intensity",step:.01},cDirectionX:{minValue:-1,maxValue:1,name:"Direction X",step:.1},cDirectionY:{minValue:-1,maxValue:1,name:"Direction Y",step:.1},cRadius:{minValue:0,maxValue:2,name:"Radius",step:.01},cInnerRadius:{minValue:0,maxValue:2,name:"InnerRadius"},cInnerRadius2:{minValue:0,maxValue:2,name:"InnerRadius2"},cWidth:{minValue:0,maxValue:1,name:"Width",step:.01},cHeight:{minValue:0,maxValue:1,name:"Height"},cDepth:{minValue:0,maxValue:1,name:"Depth"},cOffset:{minValue:0,maxValue:1,name:"Offset",step:.1},cPetals:{minValue:1,maxValue:20,name:"Petals"},cVolume:{minValue:1,maxValue:10,name:"Volume"},cBeta:{minValue:1,maxValue:10,name:"Beta"},cDelta:{minValue:.01,maxValue:.2,name:"Delta"},cScale:{minValue:.1,maxValue:1,name:"Scale"},cSize:{minValue:.1,maxValue:5,name:"Size"},cColor:{minValue:0,maxValue:1,name:"Color",step:.1},cInnerWidth:{minValue:0,maxValue:1,name:"Inner Width"},cStrength:{minValue:0,maxValue:5,name:"Strength"},cPower:{minValue:0,maxValue:1,name:"Power"},cRange:{minValue:0,maxValue:5,name:"Range"},cEmission:{minValue:0,maxValue:1,name:"Emission"},cBloom:{minValue:0,maxValue:1,name:"Bloom",step:.1},cLightX:{minValue:-1,maxValue:1,name:"Light X",step:.01},cLightY:{minValue:-1,maxValue:1,name:"Light Y",step:.01},cLightZ:{minValue:-1,maxValue:1,name:"Light Z",step:.01},cAmbient:{minValue:0,maxValue:1,name:"Ambient"},cSmoothness:{minValue:0,maxValue:1,name:"Smoothness"},cSmoothnessPower:{minValue:1,maxValue:5,name:"Smoothness Power"},cThickness:{minValue:0,maxValue:1,name:"Thickness"},cThicknessPower:{minValue:1,maxValue:5,name:"Thickness Power"},cCameraTilt:{minValue:0,maxValue:1,name:"CameraTilt",step:.01},cCameraPan:{minValue:0,maxValue:1,name:"CameraPan",step:.01},cSpeed:{minValue:0,maxValue:10,name:"Speed"},cAngle:{minValue:0,maxValue:360,name:"Angle",step:.01},cDensity:{minValue:0,maxValue:1,name:"Density",step:.01},cAlpha:{minValue:0,maxValue:1,name:"Alpha",step:.01},cDiamondGearTeeth:{minValue:8,maxValue:32,name:"Teeth",step:1},cDiamondGearMid:{minValue:0,maxValue:1,name:"Mid",step:.01},cBrushStrokeX1:{minValue:-1,maxValue:1,name:"X1",step:.01},cBrushStrokeY1:{minValue:-1,maxValue:1,name:"Y1",step:.01},cBrushStrokeX2:{minValue:-1,maxValue:1,name:"X2",step:.01},cBrushStrokeY2:{minValue:-1,maxValue:1,name:"Y2",step:.01},cBubblesVariation:{minValue:1,maxValue:2,name:"Variation",step:1},cFlameEyeInnerFade:{minValue:.01,maxValue:1,name:"InnerFade",step:.01},cFlameEyeOuterFade:{minValue:.01,maxValue:1,name:"OuterFade",step:.01},cFlameEyeBorder:{minValue:.01,maxValue:1,name:"Border",step:.01},cSplatLines:{minValue:1,maxValue:100,name:"Lines"},cSplatSpotStep:{minValue:.02,maxValue:.1,name:"Spot Step",step:.02},cTrabeculumVariation:{minValue:0,maxValue:2,name:"Variation",step:1},cLifeTime:{minValue:0,maxValue:1,name:"Life Time",step:.01},cGravity:{minValue:0,maxValue:1,name:"Gravity",step:.01},cCount:{minValue:0,maxValue:500,name:"Count",step:1},cExplosionRadius:{minValue:1,maxValue:2,name:"Radius"},cExplosionDownScale:{minValue:1,maxValue:2,name:"DownScale"},cExplosionGrain:{minValue:1,maxValue:5,name:"Grain"},cExplosionSpeed:{minValue:.1,maxValue:2,name:"Speed"},cExplosionBallness:{minValue:2,maxValue:50,name:"Ballness"},cExplosionGrowth:{minValue:.1,maxValue:3,name:"Growth"},cExplosionFade:{minValue:1,maxValue:5,name:"Fade"},cExplosionDensity:{minValue:.1,maxValue:4,name:"Density"},cExplosionContrast:{minValue:.1,maxValue:4,name:"Contrast"},cExplosionRollingInitDamp:{minValue:.1,maxValue:2,name:"RollingInitDamp"},cExplosionRollingSpeed:{minValue:0,maxValue:4,name:"RollingSpeed"},cExplosionDelayRange:{minValue:.1,maxValue:2,name:"DelayRange"},cExplosionBallSpread:{minValue:.1,maxValue:5,name:"BallSpread"},cNoiseOctave:{minValue:1,maxValue:8,name:"NoiseOctave"},cNoiseFrequency:{minValue:0,maxValue:2,name:"NoiseFrequency",step:.01},cNoisePersistence:{minValue:0,maxValue:1,name:"NoisePersistence"},cNoiseAmplitude:{minValue:0,maxValue:1,name:"NoiseAmplitude",step:.01},cNoiseScale:{minValue:0,maxValue:1,name:"NoiseScale"},cNoiseSphereEnable:{name:"NoiseSphere"},cNoiseGraphEnable:{name:"NoiseGraph"},cNoiseSize:{minValue:.1,maxValue:10,name:"NoiseSize"},cNoiseStrength:{minValue:.1,maxValue:1,name:"NoiseStrength"},cNoiseDepth:{minValue:1,maxValue:5,name:"NoiseDepth"},cNoiseLacunarity:{minValue:1,maxValue:4,step:1,name:"NoiseLacunarity"},cRepeat:{minValue:1,maxValue:8,step:1,name:"Repeat"},cScaleShift:{minValue:0,maxValue:1,name:"ScaleShift"},cBias:{minValue:-1,maxValue:1,name:"Bias"},cGain:{minValue:-1,maxValue:1,name:"Gain"},cInvert:{minValue:0,maxValue:1,name:"Invert"},cThreshold:{minValue:0,maxValue:1,name:"Threshold"},cTurbulence:{minValue:0,maxValue:1,name:"Turbulence"},cRidge:{minValue:0,maxValue:1,name:"Ridge"},cRidgeOffset:{minValue:0,maxValue:1,name:"RidgeOffset"},cGradientNoise:{minValue:0,maxValue:1,name:"GradientNoise"},cValueNoise:{minValue:0,maxValue:1,name:"ValueNoise"},cVoronoiNoise:{minValue:0,maxValue:1,name:"VoronoiNoise"},cVoronoiCell:{minValue:0,maxValue:1,name:"VoronoiCell"},cSimplexNoise:{minValue:0,maxValue:1,name:"SimplexNoise"}},a={Circle:{cPowerExponent:{minValue:0,maxValue:50}},Gradation:{cPowerExponent:{minValue:0,maxValue:50}},GradationLine:{cPowerExponent:{minValue:0,maxValue:50}},Cone:{cPowerExponent:{minValue:0,maxValue:50}},Cell:{cPowerExponent:{minValue:0,maxValue:50}},Flame:{cWidth:{minValue:.1,maxValue:2}},Lightning:{cFrequency:{minValue:0,maxValue:2},cWidth:{minValue:1,maxValue:10}},Cloud:{cCameraPan:{minValue:0,maxValue:1,defaultValue:0},cCameraTilt:{minValue:0,maxValue:1,defaultValue:0}},Checker:{cWidth:{minValue:1,maxValue:100},cHeight:{minValue:1,maxValue:100}},CoherentNoise:{cPowerExponent:{minValue:0,maxValue:5,defaultValue:1},cNoiseOctave:{minValue:1,maxValue:6,step:1,defaultValue:6},cNoiseFrequency:{minValue:1,maxValue:32,step:1,defaultValue:4},cNoiseAmplitude:{minValue:0,maxValue:2,defaultValue:1},cNoisePersistence:{minValue:0,maxValue:1,defaultValue:.5}},FbmNoise2:{cNoiseOctave:{minValue:1,maxValue:3,defaultValue:3},cNoiseAmplitude:{minValue:0,maxValue:.5,defaultValue:.25},cNoiseFrequency:{minValue:0,maxValue:1,defaultValue:1}},FbmNoise3:{cNoiseOctave:{minValue:1,maxValue:8,defaultValue:5},cNoiseAmplitude:{minValue:.5,maxValue:1.5,defaultValue:1},cNoiseFrequency:{minValue:0,maxValue:2,defaultValue:.5},cNoiseScale:{minValue:.01,maxValue:1}},MarbleNoise:{cScale:{minValue:1,maxValue:100},cFrequency:{minValue:1,maxValue:100}},TessNoise:{cNoiseFrequency:{minValue:0,maxValue:1,defaultValue:.1}},FlameEye:{cSpeed:{minValue:.1,maxValue:1}},FlameLance:{cSize:{minValue:1,maxValue:100},cSpeed:{minValue:.1,maxValue:5},cPower:{minValue:.1,maxValue:10},cAngle:{minValue:-1,maxValue:1}},Bonfire:{cSpeed:{minValue:.1,maxValue:1},cIntensity:{minValue:.1,maxValue:5},cStrength:{minValue:.1,maxValue:1},cDensity:{minValue:.1,maxValue:4},cSize:{minValue:0,maxValue:10}},Snow:{cDensity:{minValue:.1,maxValue:6},cRange:{minValue:.1,maxValue:1}},DiamondGear:{cWidth:{minValue:.1,maxValue:8}},BrushStroke:{cWidth:{minValue:0,maxValue:1,defaultValue:.3},cAlpha:{minValue:0,maxValue:1,defaultValue:.58},cStrength:{minValue:.1,maxValue:1,defaultValue:.6},cAngle:{minValue:0,maxValue:1},cAmplitude:{minValue:0,maxValue:1}},Speckle:{cRadius:{minValue:.01,maxValue:1,defaultValue:1},cDensity:{minValue:.01,maxValue:1,defaultValue:.1},cScale:{minValue:.01,maxValue:1,defaultValue:.01}},Pentagon:{cWidth:{minValue:.01,maxValue:1,defaultValue:.02},cScale:{minValue:.01,maxValue:1,defaultValue:.5},cAlpha:{minValue:.01,maxValue:1,defaultValue:.38}},Grunge:{cRadius:{minValue:.01,maxValue:1}},Energy:{cPower:{minValue:0,maxValue:1},cFrequency:{minValue:0,maxValue:1}},Particle:{cSize:{minValue:.01,maxValue:.5}},Electric:{cFrequency:{minValue:10,maxValue:50},cScale:{minValue:.01,maxValue:1}},Caustics:{cScale:{minValue:1,maxValue:10},cSpeed:{minValue:1,maxValue:4}},Squiggles:{cSize:{minValue:1,maxValue:8},cScale:{minValue:.01,maxValue:1,defaultValue:.5},cDensity:{minValue:1,maxValue:16}},WaterTurbulence:{cSize:{minValue:.01,maxValue:1,defaultValue:.4},cIntensity:{minValue:.01,maxValue:1,defaultValue:.15}},Trabeculum:{cDensity:{minValue:0,maxValue:1,defaultValue:1},cScale:{minValue:.01,maxValue:1,defaultValue:1},cCameraPan:{minValue:0,maxValue:1,defaultValue:.5},cCameraTilt:{minValue:0,maxValue:1,defaultValue:.5}}},i={Wood:["cFrequency","cPowerExponent"],Circle:["cRadius","cPowerExponent"],Solar:["cIntensity","cPowerExponent"],Spark:["cIntensity","cPowerExponent"],Ring:["cRadius","cWidth","cPowerExponent"],Gradation:["cDirectionX","cDirectionY","cPowerExponent"],GradationLine:["cDirectionX","cDirectionY","cOffset","cPowerExponent"],Flash:["cFrequency","cPowerExponent"],Cone:["cDirectionX","cDirectionY","cPowerExponent"],Flower:["cPetals","cRadius","cIntensity","cPowerExponent"],FlowerFun:["cPetals","cRadius","cOffset","cIntensity","cPowerExponent"],WaveRing:["cRadius","cWidth","cFrequency","cAmplitude","cPowerExponent"],Flame:["cIntensity","cWidth","cScale"],FlameEye:["cSpeed","cFlameEyeInnerFade","cFlameEyeOuterFade","cFlameEyeBorder","cColor"],Cell:["cIntensity","cPowerExponent","cSize"],Smoke:["cVolume","cBeta","cDelta"],Lightning:["cIntensity","cFrequency","cWidth"],Flare:["cIntensity","cPowerExponent"],Flare2:["cIntensity","cPowerExponent"],Flare3:["cIntensity","cPowerExponent"],MagicCircle:[],Mandara:["cRadius","cInnerRadius","cInnerRadius2"],Cross:["cIntensity","cPowerExponent"],Explosion:["cCameraTilt","cCameraPan","cExplosionRadius","cExplosionDownScale","cExplosionGrain","cExplosionSpeed","cExplosionBallness","cExplosionGrowth","cExplosionFade","cExplosionDensity","cExplosionContrast","cExplosionRollingInitDamp","cExplosionRollingSpeed","cExplosionDelayRange","cExplosionBallSpread"],Explosion2:["cCameraPan","cExplosionSpeed","cExplosionDensity","cEmission","cBloom","cColor"],Corona:["cIntensity","cRadius","cSize"],Fire:["cIntensity","cStrength","cPower","cRange","cWidth","cColor"],LensFlare:["cRadius","cRange","cColor","cPowerExponent"],Sun:["cRadius","cColor"],Laser:["cWidth","cColor"],Laser2:["cWidth","cInnerWidth"],Light:["cRadius","cPowerExponent","cColor"],Cloud:["cWidth","cHeight","cDepth","cIntensity","cLightX","cLightY","cLightZ","cAmbient","cSmoothness","cSmoothnessPower","cThickness","cThicknessPower","cCameraTilt","cCameraPan"],Cloud2:["cIntensity","cDensity","cThickness","cColor"],CoherentNoise:["cNoiseOctave","cNoiseFrequency","cNoiseAmplitude","cNoiseLacunarity","cNoisePersistence","cGradientNoise","cValueNoise","cVoronoiNoise","cVoronoiCell","cSimplexNoise","cRepeat","cTurbulence","cRidge","cRidgeOffset","cScaleShift","cPowerExponent","cBias","cGain","cThreshold","cInvert","cNoiseSphereEnable","cNoiseGraphEnable"],PerlinNoise:["cNoiseOctave","cNoisePersistence","cNoiseSphereEnable","cNoiseGraphEnable"],SeemlessNoise:["cNoiseOctave","cNoisePersistence","cNoiseScale","cNoiseSphereEnable","cNoiseGraphEnable"],BooleanNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],CellNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],RandomNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],FbmNoise:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],FbmNoise2:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cScale","cNoiseSphereEnable","cNoiseGraphEnable"],FbmNoise3:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cNoiseScale","cOffset","cNoiseSphereEnable","cNoiseGraphEnable"],TurbulentNoise:["cNoiseOctave","cNoiseAmplitude","cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],SparkNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],VoronoiNoise:["cNoiseFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],MarbleNoise:["cScale","cFrequency","cNoiseSphereEnable","cNoiseGraphEnable"],TessNoise:["cNoiseFrequency","cOffset","cNoiseSphereEnable","cNoiseGraphEnable"],GradientNoise:["cNoiseScale","cColor","cNoiseSphereEnable","cNoiseGraphEnable"],Checker:["cWidth","cHeight"],FlameLance:["cSize","cSpeed","cPower","cAngle","cColor","cNoiseSize","cNoiseStrength","cNoiseDepth"],Bonfire:["cSpeed","cIntensity","cStrength","cDensity","cSize","cColor"],Snow:["cSpeed","cScale","cDensity","cRange"],DiamondGear:["cScale","cWidth","cRadius","cDiamondGearTeeth","cDiamondGearMid"],BrushStroke:["cWidth","cStrength","cAlpha","cAngle","cAmplitude","cBrushStrokeX1","cBrushStrokeY1","cBrushStrokeX2","cBrushStrokeY2","cColor"],Speckle:["cRadius","cScale","cDensity"],Bubbles:["cRadius","cWidth","cThickness","cColor","cBubblesVariation"],Pentagon:["cScale","cAlpha","cWidth"],Grunge:["cRadius","cScale"],Energy:["cPower","cDensity","cThickness","cScale","cFrequency","cColor"],InkSplat:["cSplatLines","cSplatSpotStep"],Particle:["cSize","cLifeTime","cGravity","cCount"],Electric:["cFrequency","cScale"],Caustics:["cScale","cSpeed","cColor"],Squiggles:["cSize","cScale","cDensity"],WaterTurbulence:["cScale","cIntensity"],Trabeculum:["cDensity","cScale","cIntensity","cTrabeculumVariation","cCameraTilt","cCameraPan","cColor"],BinaryMatrix:[],Test:[]}[this.effectController.type];for(let n=0;n<i.length;n++){i[n]in e&&(this.effectController[i[n]]=e[i[n]].value);let l=t[i[n]];if(i[n].indexOf("Enable")>=0)this.gui.parsItems.push(this.gui.pars.add(this.effectController,i[n]).name(l.name));else{let e=!1;if(this.effectController.type in a&&i[n]in a[this.effectController.type]&&(e=!0),e){let e=a[this.effectController.type][i[n]];"defaultValue"in e&&(this.effectController[i[n]]=e.defaultValue);let t=this.gui.pars.add(this.effectController,i[n],e.minValue,e.maxValue).name(l.name);"step"in l&&t.step(l.step),"step"in e&&t.step(e.step),this.gui.parsItems.push(t)}else{let e=this.gui.pars.add(this.effectController,i[n],l.minValue,l.maxValue).name(l.name);"step"in l&&e.step(l.step),this.gui.parsItems.push(e)}}}},updateSaveBuffer(){this.saveCanvas.width=this.canvas.width,this.saveCanvas.height=this.canvas.height;const e=this.saveCanvas.getContext("2d",{willReadFrequently:!0});if(this.alphaOptions.blur>0){this.blur50.width=.5*this.canvas.width,this.blur50.height=.5*this.canvas.height,this.blur25.width=.25*this.canvas.width,this.blur25.height=.25*this.canvas.height;let t=this.blur50,a=this.blur25,i=t.getContext("2d"),n=a.getContext("2d");n.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,a.width,a.height),i.drawImage(a,0,0,a.width,a.height,0,0,t.width,t.height);for(let e=0;e<this.alphaOptions.blur;e++)n.drawImage(t,0,0,t.width,t.height,0,0,a.width,a.height),i.drawImage(a,0,0,a.width,a.height,0,0,t.width,t.height),[t,a,i,n]=[a,t,n,i];e.drawImage(t,0,0,t.width,t.height,0,0,this.canvas.width,this.canvas.height)}else e.drawImage(this.canvas,0,0);const t=Math.round(255*this.alphaOptions.threshold),a=Math.round(255*this.alphaOptions.tolerance),i=e.getImageData(0,0,this.canvas.width,this.canvas.height);let n=i.data;for(let e=0;e<n.length;e+=4){const i=n[e+0]>a?255:n[e+0]<t?0:n[e+0],l=n[e+1]>a?255:n[e+1]<t?0:n[e+1],r=n[e+2]>a?255:n[e+2]<t?0:n[e+2],s=Math.round(Math.max(i,l,r));n[e+3]=s}i.data.set(n),e.putImageData(i,0,0)},updateAlphaBuffer(){this.updateSaveBuffer(),this.alphaCanvas.width=this.canvas.width,this.alphaCanvas.height=this.canvas.height;const e=this.alphaCanvas.getContext("2d",{willReadFrequently:!0});e.drawImage(this.saveCanvas,0,0);const t=e.getImageData(0,0,this.canvas.width,this.canvas.height),a=t.data;for(let e=0;e<a.length;e+=4)a[e+0]=a[e+1]=a[e+2]=a[e+3],a[e+3]=255;t.data.set(a),e.putImageData(t,0,0)},animate(){this.effectController.animate&&(this.effectController.time+=this.clock.getDelta());const e=this.effectController.time;let t=e.toString()+"0000000";0===e&&(t="0.00000000"),document.getElementById("time").innerHTML=t.slice(0,8),requestAnimationFrame(this.animate.bind(this)),this.render(),this.alphaOptions.visible&&(this.effectController.animate||this.alphaOptions.update)&&this.updateAlphaBuffer()},render(){this.stats.update();for(let a=0;a<this.layers.length;a++){let i=this.layers[a],n=i.renderTarget,l=i.tDiffuse;"NormalMap"===i.name&&!1===this.effectController.normalMap&&(i=this.layers[this.layers.length-1]),"PolarConversion"===i.name&&!1===this.effectController.polarConversion&&(i=this.layers[this.layers.length-1]),"Tiling"===i.name&&!1===this.effectController.tiling&&(i=this.layers[this.layers.length-1]),i.uniforms.resolution.value=new e.Vector2(this.canvas.width,this.canvas.height),this.camera.getWorldPosition(i.uniforms.cameraPos.value),this.camera.getWorldDirection(i.uniforms.cameraDir.value),i.uniforms.mouse.value.copy(this.mouse),i.uniforms.tDiffuse.value=l;const r=Object.keys(this.effectController);for(let e in r){const a=r[e];"resolution"!==a&&t.FxgenShaderUtils.SetShaderParameter(i.uniforms,a,this.effectController[a])}t.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cColorBalanceShadows",new e.Vector3(this.effectController.cColorBalanceShadowsR,this.effectController.cColorBalanceShadowsG,this.effectController.cColorBalanceShadowsB)),t.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cColorBalanceMidtones",new e.Vector3(this.effectController.cColorBalanceMidtonesR,this.effectController.cColorBalanceMidtonesG,this.effectController.cColorBalanceMidtonesB)),t.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cColorBalanceHighlights",new e.Vector3(this.effectController.cColorBalanceHighlightsR,this.effectController.cColorBalanceHighlightsG,this.effectController.cColorBalanceHighlightsB)),t.FxgenShaderUtils.SetShaderParameter(i.uniforms,"cDirection",new e.Vector2(this.effectController.cDirectionX,this.effectController.cDirectionY)),t.FxgenShaderUtils.SetShaderParameter(i.uniforms,"tGrunge",this.grungeTexture),this.scene.overrideMaterial=i.material,this.renderer.setRenderTarget(n),this.renderer.render(this.scene,this.dummyCamera),this.renderer.setRenderTarget(null),this.scene.overrideMaterial=null}this.effectController.cNoiseSphereEnable&&(this.noise.uniforms.tDisplacement.value=this.layers[this.layers.length-2].renderTarget.texture,this.renderer.render(this.noise.scene,this.camera))}},o=document.createElement("a");function c(){if(console.log("[fxgen] onWindowResize"),s.renderer.setSize(s.canvas.width,s.canvas.height),s.layers)for(let t=0;t<s.layers.length;t++)s.layers[t].renderTarget&&(s.layers[t].renderTarget=new e.WebGLRenderTarget(s.canvas.width,s.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1})),s.layers[t].tDiffuse&&(s.layers[t].tDiffuse=s.layers[t-1].renderTarget.texture),"Tiling"===s.layers[t].name&&(s.layers[t].tDiffuse.wrapS=s.layers[t].tDiffuse.wrapT=e.RepeatWrapping);s.spriteSheet.renderTarget=new e.WebGLRenderTarget(s.canvas.width,s.canvas.height,{minFilter:e.LinearFilter,magFilter:e.LinearFilter,stencilBuffer:!1}),s.render()}o.style.display="none",document.body.appendChild(o),s.init(),s.animate(),window.addEventListener("resize",c,!1),console.log("[fxgen] ready");
